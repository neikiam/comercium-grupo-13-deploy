{% extends "base.html" %}
{% block title %}Solicitudes de chat{% endblock %}
{% block content %}
<div class="container" style="max-width: 900px; margin: 2rem auto;">
  <h2 style="margin-bottom: 1rem; text-align:center;">Solicitudes de chat</h2>
  <p style="text-align:center; margin-bottom: 1rem;"><a class="btn-retro btn-small" href="{% url 'chat_interno:home' %}">â¬… Volver al centro</a></p>

  <div class="retro-panel" style="margin-bottom: 1rem;">
    <h3>Recibidas</h3>
    {% if incoming %}
      <ul id="incoming-list" style="list-style:none; padding:0; margin:0;">
        {% for cr in incoming %}
          <li id="request-{{ cr.id }}" style="padding:0.75rem 0; border-bottom:1px solid var(--retro-border); display:flex; align-items:center; gap:0.75rem;">
            {% if cr.requester.profile.avatar %}
              <img src="{{ cr.requester.profile.avatar.url }}" alt="{{ cr.requester.username }}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--retro-border);">
            {% else %}
              <img src="https://ui-avatars.com/api/?name={{ cr.requester.username }}&background=random&size=40" alt="{{ cr.requester.username }}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--retro-border);">
            {% endif %}
            <a href="{% url 'perfil:user_profile_view' cr.requester.id %}" class="nav-link-retro" style="flex:1;">ğŸ‘¤ {{ cr.requester.username }}</a>
            <form method="post" action="{% url 'chat_interno:request-accept' cr.id %}" onsubmit="return handleRequestAction(event, {{ cr.id }}, 'accept')">
              {% csrf_token %}
              <button class="btn-retro btn-small" type="submit">âœ… Aceptar</button>
            </form>
            <form method="post" action="{% url 'chat_interno:request-decline' cr.id %}" onsubmit="return handleRequestAction(event, {{ cr.id }}, 'decline')">
              {% csrf_token %}
              <button class="btn-retro btn-small" type="submit">âŒ Rechazar</button>
            </form>
            <form method="post" action="{% url 'chat_interno:block-user' cr.requester.id %}">
              {% csrf_token %}
              <button class="btn-retro btn-small" type="submit">ğŸš« Bloquear</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p id="no-incoming" style="margin:0; color:#666;">No tienes solicitudes recibidas.</p>
    {% endif %}
  </div>

  <div class="retro-panel">
    <h3>Enviadas</h3>
    {% if outgoing %}
      <ul style="list-style:none; padding:0; margin:0;">
        {% for cr in outgoing %}
          <li style="padding:0.75rem 0; border-bottom:1px solid var(--retro-border); display:flex; align-items:center; gap:0.75rem;">
            {% if cr.target.profile.avatar %}
              <img src="{{ cr.target.profile.avatar.url }}" alt="{{ cr.target.username }}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--retro-border);">
            {% else %}
              <img src="https://ui-avatars.com/api/?name={{ cr.target.username }}&background=random&size=40" alt="{{ cr.target.username }}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--retro-border);">
            {% endif %}
            <a href="{% url 'perfil:user_profile_view' cr.target.id %}" class="nav-link-retro" style="flex:1;">ğŸ‘¤ {{ cr.target.username }}</a>
            <span style="color:#999;">Pendienteâ€¦</span>
            <form method="post" action="{% url 'chat_interno:block-user' cr.target.id %}">
              {% csrf_token %}
              <button class="btn-retro btn-small" type="submit">ğŸš« Bloquear</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p style="margin:0; color:#666;">No tienes solicitudes enviadas.</p>
    {% endif %}
  </div>
</div>

<script>
function handleRequestAction(event, requestId, action) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  const button = form.querySelector('button[type="submit"]');
  
  // Deshabilitar botÃ³n mientras se procesa
  button.disabled = true;
  button.textContent = action === 'accept' ? 'â³ Aceptando...' : 'â³ Rechazando...';
  
  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Remover el elemento de la lista con animaciÃ³n
      const requestElement = document.getElementById('request-' + requestId);
      if (requestElement) {
        requestElement.style.opacity = '0';
        requestElement.style.transition = 'opacity 0.3s';
        
        setTimeout(() => {
          requestElement.remove();
          
          // Si no quedan mÃ¡s solicitudes, mostrar mensaje
          const list = document.getElementById('incoming-list');
          if (list && list.children.length === 0) {
            list.innerHTML = '<p id="no-incoming" style="margin:0; color:#666;">No tienes solicitudes recibidas.</p>';
          }
          
          // Si es aceptar, redirigir al chat
          if (action === 'accept' && data.thread_id) {
            window.location.href = `/chat/private/${data.thread_id}/`;
          }
        }, 300);
      }
    } else if (data.error) {
      alert(data.error);
      button.disabled = false;
      button.textContent = action === 'accept' ? 'âœ… Aceptar' : 'âŒ Rechazar';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // Si falla el AJAX, enviar formulario normalmente
    button.disabled = false;
    button.textContent = action === 'accept' ? 'âœ… Aceptar' : 'âŒ Rechazar';
    form.submit();
  });
  
  return false;
}
</script>
{% endblock %}
